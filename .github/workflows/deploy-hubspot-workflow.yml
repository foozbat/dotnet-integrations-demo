name: 'Deploy HubSpot Workflow'

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'hubspot-workflows/**'

env:
  HUBSPOT_ACCESS_TOKEN: ${{ secrets.HUBSPOT_ACCESS_TOKEN }}
  WEBHOOK_URL: https://${{ vars.AZURE_APP_NAME }}.azurewebsites.net/webhooks/hubspot

jobs:
  deploy-workflow:
    name: 'Deploy Workflow to HubSpot'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Deploy workflow to HubSpot
      run: |
        # Replace webhook URL placeholder with environment variable
        WORKFLOW_JSON=$(cat hubspot-workflows/create-contact-workflow.json | sed "s|{{WEBHOOK_URL}}|${{ env.WEBHOOK_URL }}|g")
        
        # Create or update the workflow via HubSpot API
        RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
          "https://api.hubapi.com/automation/v4/flows" \
          -H "Authorization: Bearer ${{ secrets.HUBSPOT_ACCESS_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d "$WORKFLOW_JSON")
        
        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        BODY=$(echo "$RESPONSE" | sed '$d')
        
        echo "Response: $BODY"
        echo "HTTP Status: $HTTP_CODE"
        
        if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
          echo "Workflow deployed successfully."
        else
          echo "Workflow deployment failed with status $HTTP_CODE"
          exit 1
        fi